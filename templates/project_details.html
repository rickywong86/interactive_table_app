<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Project Details</title>
    <!-- Bootstrap CSS for styling -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
        xintegrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <style>
        .text-wrap {
            white-space: normal;
        }

        .pagination-container {
            display: flex;
            justify-content: center;
        }

        .highlight-row {
            /* animation: highlight-fade 2s ease-in-out; */
            background-color: #d1e7dd;
            /* A light green color for success highlight */
        }

        @keyframes highlight-fade {
            0% {
                background-color: #fff3cd;
            }

            /* A temporary highlight color on start */
            100% {
                background-color: transparent;
            }
        }
    </style>
</head>

<body>
    <div class="container mt-5">
        <a href="{{ url_for('project.index') }}" class="btn btn-outline-secondary mb-4">&larr; Back to Projects</a>

        <h1 class="mb-4">Project Details</h1>

        <div class="row">
            <div class="col-md-12">
                <h6>Project Information</h6>
                <table class="table table-bordered table-sm">
                    <tbody>
                        <tr>
                            <th>ID</th>
                            <td id="viewProjectId">{{ project.id }}</td>
                        </tr>
                        <tr>
                            <th>Description</th>
                            <td id="viewProjectDescription">{{ project.description }}</td>
                        </tr>
                        <tr>
                            <th>Created</th>
                            <td id="viewProjectCreated">{{ project.created.strftime('%Y-%m-%d %H:%M') }}</td>
                        </tr>
                        <tr>
                            <th>Completed</th>
                            <td id="viewProjectCompleted">{{ 'Yes' if project.completed else 'No' }}</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
        <hr>
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h6>Transactions</h6>
            <div class="d-flex align-items-center">
                <div class="me-3">
                    <label for="perPageSelect" class="form-label me-2 mb-0">Items per page:</label>
                    <select class="form-select form-select-sm" id="perPageSelect">
                        <option value="5">5</option>
                        <option value="10" selected>10</option>
                        <option value="15">15</option>
                        <option value="20">20</option>
                        <option value="25">25</option>
                        <option value="30">30</option>
                    </select>
                </div>
                <a href="{{ url_for('project.export_csv', project_id=project.id) }}"
                    class="btn btn-sm btn-success me-2">Export CSV</a>
                <form id="uploadForm" class="d-flex me-2" enctype="multipart/form-data">
                    <input type="hidden" id="uploadProjectId" value="{{ project.id }}">
                    <label for="fileUpload" class="form-label me-2 mb-0">Upload CSV:</label>
                    <input type="file" class="form-control form-control-sm me-2" id="fileUpload" name="file"
                        accept=".csv, .txt" required>

                    <label for="sourceAssetSelect" class="form-label me-2 mb-0">Source Asset:</label>
                    <select class="form-select form-select-sm me-2" id="sourceAssetSelect" name="source_asset" required>
                        <!-- Assets will be loaded here via JavaScript -->
                    </select>

                    <button type="submit" class="btn btn-success btn-sm">Import</button>
                </form>
                <button id="refreshScoresBtn" class="btn btn-primary btn-sm me-2">Refresh All Scores</button>
                <button id="deleteAllTransactionsBtn" class="btn btn-danger btn-sm" data-bs-toggle="modal"
                    data-bs-target="#deleteAllTransactionsModal">Delete All</button>
            </div>
        </div>
        <div class="table-responsive">
            <table class="table table-sm table-striped">
                <thead class="table-dark">
                    <tr>
                        <th>Date</th>
                        <th>Description</th>
                        <th>Amount</th>
                        <th>Category</th>
                        <th>Source Account</th>
                        <th>Destination Account</th>
                        <th>Score</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="transactionsTableBody">
                    <!-- Transactions will be loaded here via JavaScript -->
                </tbody>
            </table>
        </div>

        <!-- Transaction Pagination Controls -->
        <nav class="pagination-container mt-3" aria-label="Transaction navigation">
            <ul class="pagination" id="transactionPagination">
                <!-- Pagination links will be generated by JavaScript -->
            </ul>
        </nav>
    </div>

    <!-- Edit Transaction Modal -->
    <div class="modal fade" id="editTransactionModal" tabindex="-1" aria-labelledby="editTransactionModalLabel"
        aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <form id="editTransactionForm">
                    <div class="modal-header">
                        <h5 class="modal-title" id="editTransactionModalLabel">Edit Transaction</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <input type="hidden" id="editTransactionId">
                        <div class="mb-3">
                            <label for="editTransCategory" class="form-label">Category</label>
                            <input class="form-control" list="categoryOptions" id="editTransCategory"
                                placeholder="Type to search or add new...">
                            <datalist id="categoryOptions">
                                <!-- Options will be loaded via JavaScript -->
                            </datalist>
                        </div>
                        <!-- <div class="mb-3">
                            <label for="editTransSourceAcc" class="form-label">Source Account</label>
                            <select class="form-select" id="editTransSourceAcc">
                                <option value="" disabled selected>Select an asset</option>
                                {% for asset in assets %}
                                <option value="{{ asset.name }}">{{ asset.name }}</option>
                                {% endfor %}
                            </select>
                        </div> -->
                        <div class="mb-3">
                            <label for="editTransDestinationAcc" class="form-label">Destination Account</label>
                            <input class="form-control" list="destinationAccOptions" id="editTransDestinationAcc"
                                placeholder="Type to search or add new...">
                            <datalist id="destinationAccOptions">
                                <!-- Options will be loaded via JavaScript -->
                            </datalist>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        <button type="submit" class="btn btn-primary">Save changes</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Delete Transaction Confirmation Modal (Single Transaction) -->
    <div class="modal fade" id="deleteTransactionConfirmModal" tabindex="-1"
        aria-labelledby="deleteTransactionConfirmModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="deleteTransactionConfirmModalLabel">Confirm Transaction Deletion</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    Are you sure you want to delete this transaction? This action cannot be undone.
                    <input type="hidden" id="deleteTransId">
                    <input type="hidden" id="deleteTransProjectId">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger" id="deleteTransactionConfirmBtn">Delete</button>
                </div>
            </div>
        </div>
    </div>


    <!-- Delete All Transactions Modal -->
    <div class="modal fade" id="deleteAllTransactionsModal" tabindex="-1"
        aria-labelledby="deleteAllTransactionsModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="deleteAllTransactionsModalLabel">Delete Transactions</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>Are you sure you want to delete transactions for this project? This action cannot be undone.</p>
                    <div class="mb-3">
                        <label for="deleteAssetSelect" class="form-label">Select an asset to delete transactions from
                            (optional):</label>
                        <select class="form-select" id="deleteAssetSelect">
                            <option value="">All Transactions</option>
                            {% for asset in assets %}
                            <option value="{{ asset.name }}">{{ asset.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger" id="deleteAllTransactionsConfirmBtn">Delete</button>
                </div>
            </div>
        </div>
    </div>


    <!-- jQuery and Bootstrap JS -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"
        integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
        xintegrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
        crossorigin="anonymous"></script>

    <script>
        $(document).ready(function () {
            // Get the project ID from the hidden input field
            const projectId = $('#viewProjectId').text().trim();

            const urlParams = new URLSearchParams(window.location.search);
            const initialHighlightId = urlParams.get('highlight_id');

            let currentPage = 1;
            let perPage = $('#perPageSelect').val();

            // Function to fetch and render the transactions table and pagination
            const fetchAndRenderTransactions = (id, page, per_page, highlightId = null) => {
                const tableBodyElement = $('#transactionsTableBody');
                const paginationElement = $('#transactionPagination');

                tableBodyElement.empty().append('<tr><td colspan="8" class="text-center">Loading...</td></tr>');
                paginationElement.empty();

                $.get(`/project/${id}/transactions?page=${page}&per_page=${per_page}`, function (data) {
                    tableBodyElement.empty();
                    if (data.transactions.length > 0) {
                        data.transactions.forEach(transaction => {
                            const highlightClass = (highlightId && transaction.id.toString() === highlightId.toString()) ? 'highlight-row' : '';
                            const row = `
                                <tr class="${highlightClass}"> 
                                    <td>${new Date(transaction.transdate).toLocaleDateString()}</td>
                                    <td>${transaction.desc}</td>
                                    <td>${transaction.amount}</td>
                                    <td>${transaction.category || ''}</td>
                                    <td>${transaction.sourceAcc || ''}</td>
                                    <td>${transaction.destinationAcc || ''}</td>
                                    <td>${transaction.score || ''}</td>
                                    <td>
                                        <button class="btn btn-sm btn-warning edit-transaction-btn" data-bs-toggle="modal" data-bs-target="#editTransactionModal"
                                            data-id="${transaction.id}" data-desc="${transaction.desc}" data-category="${transaction.category || ''}" data-sourceacc="${transaction.sourceAcc || ''}" data-destinationacc="${transaction.destinationAcc || ''}" data-project-id="${id}">
                                            Edit
                                        </button>
                                        <button class="btn btn-sm btn-info refresh-score-btn" data-id="${transaction.id}" data-project-id="${id}">
                                            Refresh
                                        </button>
                                        <button class="btn btn-sm btn-danger delete-transaction-btn" data-bs-toggle="modal" data-bs-target="#deleteTransactionConfirmModal" data-id="${transaction.id}" data-project-id="${id}">
                                            Delete
                                        </button>
                                    </td>
                                </tr>
                            `;
                            tableBodyElement.append(row);
                        });
                    } else {
                        tableBodyElement.append('<tr><td colspan="8" class="text-center">No transactions found.</td></tr>');
                    }

                    // Render pagination controls
                    if (data.pages > 1) {
                        // Previous button
                        const prevDisabled = data.prev_num === null ? 'disabled' : '';
                        const prevItem = `<li class="page-item ${prevDisabled}"><a class="page-link" href="#" data-page="${data.prev_num}">Previous</a></li>`;
                        paginationElement.append(prevItem);

                        // Page numbers
                        for (let i = 1; i <= data.pages; i++) {
                            const activeClass = i === data.page ? 'active' : '';
                            const pageItem = `<li class="page-item ${activeClass}"><a class="page-link" href="#" data-page="${i}">${i}</a></li>`;
                            paginationElement.append(pageItem);
                        }

                        // Next button
                        const nextDisabled = data.next_num === null ? 'disabled' : '';
                        const nextItem = `<li class="page-item ${nextDisabled}"><a class="page-link" href="#" data-page="${data.next_num}">Next</a></li>`;
                        paginationElement.append(nextItem);
                    }

                    // Add click handlers to the new page links
                    $('.page-link').on('click', function (e) {
                        e.preventDefault();
                        const newPage = $(this).data('page');
                        if (newPage) {
                            currentPage = newPage;
                            fetchAndRenderTransactions(projectId, currentPage, perPage);
                        }
                    });

                }).fail(function (jqXHR, textStatus, errorThrown) {
                    tableBodyElement.empty().append('<tr><td colspan="8" class="text-center text-danger">Error fetching transactions.</td></tr>');
                    alert('Error fetching transactions: ' + errorThrown);
                    console.error('Error fetching transactions:', textStatus, errorThrown);
                });
            };

            // Function to fetch and populate asset dropdowns
            const populateAssetDropdowns = () => {
                $.get('/assets/list', function (data) {
                    const uploadAssetSelect = $('#sourceAssetSelect');
                    const editAssetSelect = $('#editTransSourceAcc');
                    const deleteAssetSelect = $('#deleteAssetSelect');

                    // Clear existing options
                    uploadAssetSelect.empty();
                    editAssetSelect.empty();
                    deleteAssetSelect.find('option:not(:first)').remove(); // Keep "All Transactions"

                    // Add default option
                    uploadAssetSelect.append('<option value="" disabled selected>Select an asset</option>');

                    // Populate with fetched assets
                    data.forEach(asset => {
                        const option = `<option value="${asset.name}">${asset.name}</option>`;
                        uploadAssetSelect.append(option);
                        editAssetSelect.append(option);
                        deleteAssetSelect.append(option);
                    });
                }).fail(function (jqXHR, textStatus, errorThrown) {
                    console.error('Error fetching assets:', textStatus, errorThrown);
                });
            };

            // Call the function on page load to populate the assets table.
            populateAssetDropdowns();

            // Initial population of transactions and assets on page load
            fetchAndRenderTransactions(projectId, currentPage, perPage);

            // Handle per-page dropdown change
            $('#perPageSelect').on('change', function () {
                perPage = $(this).val();
                currentPage = 1; // Reset to first page on per-page change
                fetchAndRenderTransactions(projectId, currentPage, perPage);
            });

            // File Upload Form Submission
            $('#uploadForm').on('submit', function (e) {
                e.preventDefault();
                const form = $(this);
                const fileInput = $('#fileUpload')[0];
                const sourceAsset = $('#sourceAssetSelect').val();

                if (fileInput.files.length > 0 && sourceAsset) {
                    const formData = new FormData();
                    formData.append('file', fileInput.files[0]);
                    formData.append('source_asset', sourceAsset);

                    $.ajax({
                        url: `/project/${projectId}/upload`,
                        type: 'POST',
                        data: formData,
                        processData: false,
                        contentType: false,
                        success: function (response) {
                            alert(response.message);
                            fileInput.value = ''; // Reset the file input
                            fetchAndRenderTransactions(projectId, currentPage, perPage); // Refresh the table
                        },
                        error: function (jqXHR, textStatus, errorThrown) {
                            alert('Error uploading file: ' + (jqXHR.responseJSON ? jqXHR.responseJSON.message : errorThrown));
                        }
                    });
                } else {
                    alert('Please select a file and an asset to upload.');
                }
            });

            // Refresh All Scores button handler
            $('#refreshScoresBtn').on('click', function () {
                if (confirm('Are you sure you want to refresh the semantic scores for all transactions?')) {
                    $.ajax({
                        url: `/project/${projectId}/refresh_scores`,
                        type: 'POST',
                        success: function (response) {
                            alert(response.message);
                            fetchAndRenderTransactions(projectId, currentPage, perPage); // Refresh the table
                        },
                        error: function (jqXHR, textStatus, errorThrown) {
                            alert('Error refreshing scores: ' + (jqXHR.responseJSON ? jqXHR.responseJSON.message : errorThrown));
                        }
                    });
                }
            });

            // Delete All Transactions button handler (modal's confirm button)
            $('#deleteAllTransactionsConfirmBtn').on('click', function () {
                const assetName = $('#deleteAssetSelect').val();
                let url = `/project/${projectId}/transactions/delete_all`;
                if (assetName) {
                    url += `?asset_name=${assetName}`;
                }

                $.ajax({
                    url: url,
                    type: 'DELETE',
                    success: function (response) {
                        alert(response.message);
                        $('#deleteAllTransactionsModal').modal('hide');
                        fetchAndRenderTransactions(projectId, currentPage, perPage);
                    },
                    error: function (jqXHR, textStatus, errorThrown) {
                        alert('Error deleting transactions: ' + (jqXHR.responseJSON ? jqXHR.responseJSON.message : errorThrown));
                    }
                });
            });

            // Edit Transaction Modal Logic
            $('#editTransactionModal').on('show.bs.modal', function (event) {
                const button = $(event.relatedTarget);
                const transactionId = button.data('id');
                const desc = button.data('desc');
                const category = button.data('category');
                const sourceAcc = button.data('sourceacc');
                const destinationAcc = button.data('destinationacc');

                const modal = $(this);
                modal.find('#editTransactionId').val(transactionId);
                modal.find('#editTransCategory').val(category);
                modal.find('#editTransDestinationAcc').val(destinationAcc);

                // Set the selected value for the sourceAcc dropdown
                modal.find('#editTransSourceAcc').val(sourceAcc);

                // Fetch categories to populate datalists
                $.get('/categories/list', function (data) {
                    const categoryOptions = $('#categoryOptions');
                    const destinationAccOptions = $('#destinationAccOptions');
                    categoryOptions.empty();
                    destinationAccOptions.empty();

                    const uniqueCategories = new Set(data.map(item => item.category));
                    const uniqueDestinationAccs = new Set(data.map(item => item.destinationAcc));

                    uniqueCategories.forEach(c => {
                        categoryOptions.append(`<option value="${c}">`);
                    });
                    uniqueDestinationAccs.forEach(d => {
                        destinationAccOptions.append(`<option value="${d}">`);
                    });
                });
            });

            // Edit Transaction Form Submission
            $('#editTransactionForm').on('submit', function (e) {
                e.preventDefault();
                const form = $(this);
                const transactionId = $('#editTransactionId').val();

                const formData = {
                    category: $('#editTransCategory').val(),
                    // sourceAcc: $('#editTransSourceAcc').val(),
                    destinationAcc: $('#editTransDestinationAcc').val()
                };

                $.ajax({
                    url: `/transaction/${transactionId}/update`,
                    type: 'PUT',
                    contentType: 'application/json',
                    data: JSON.stringify(formData),
                    success: function (response) {
                        alert(response.message);
                        $('#editTransactionModal').modal('hide');
                        fetchAndRenderTransactions(projectId, currentPage, perPage, transactionId);
                    },
                    error: function (jqXHR, textStatus, errorThrown) {
                        alert('Error updating transaction: ' + (jqXHR.responseJSON ? jqXHR.responseJSON.message : errorThrown));
                    }
                });
            });

            // Refresh Score button handler for individual transaction
            $(document).on('click', '.refresh-score-btn', function () {
                const transactionId = $(this).data('id');

                if (confirm('Are you sure you want to refresh the semantic score for this transaction?')) {
                    $.ajax({
                        url: `/transaction/${transactionId}/refresh_score`,
                        type: 'POST',
                        success: function (response) {
                            alert(response.message);
                            fetchAndRenderTransactions(projectId, currentPage, perPage); // Refresh the table
                        },
                        error: function (jqXHR, textStatus, errorThrown) {
                            alert('Error refreshing score: ' + (jqXHR.responseJSON ? jqXHR.responseJSON.message : errorThrown));
                        }
                    });
                }
            });

            // Delete Transaction Modal Logic (Single Transaction)
            $(document).on('click', '.delete-transaction-btn', function (event) {
                const button = $(event.target);
                const transactionId = button.data('id');
                const projectId = button.data('project-id');

                $('#deleteTransId').val(transactionId);
                $('#deleteTransProjectId').val(projectId);
            });

            // Delete Transaction Confirmation Button handler
            $('#deleteTransactionConfirmBtn').on('click', function () {
                const transactionId = $('#deleteTransId').val();

                $.ajax({
                    url: `/transaction/${transactionId}/delete`,
                    type: 'DELETE',
                    success: function (response) {
                        alert(response.message);
                        $('#deleteTransactionConfirmModal').modal('hide');
                        fetchAndRenderTransactions(projectId, currentPage, perPage); // Refresh the table
                    },
                    error: function (jqXHR, textStatus, errorThrown) {
                        alert('Error deleting transaction: ' + (jqXHR.responseJSON ? jqXHR.responseJSON.message : errorThrown));
                    }
                });
            });
        });
    </script>
</body>

</html>